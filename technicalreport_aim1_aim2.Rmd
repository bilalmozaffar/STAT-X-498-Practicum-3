---
title: "Aim 1 and 2"
author: "Nijia Ke"
date: "4/21/2021"
output: pdf_document
---

```{r warning=FALSE, message=FALSE}
library(imputeTS)
library(ggplot2)
library(PerformanceAnalytics)
library(ggpubr)
```

```{r warning=FALSE, message=FALSE}
otter = read.csv("otter2.csv", header = TRUE)

# impute the missing values for Altitude and store the values after imputation in a new variable called imp_Altitude
otter$imp_Altitude = c(na_kalman(otter$Altitude[1:20]), na_kalman(otter$Altitude[21:40]), na_kalman(otter$Altitude[41:60]), na_kalman(otter$Altitude[61:80]), na_kalman(otter$Altitude[81:100]))

#impute the missing values for Trout and store the values after imputation in a new variable called imp_Trout
otter$imp_Trout = c(na_kalman(otter$Trout[1:20]), na_kalman(otter$Trout[21:40]), na_kalman(otter$Trout[41:60]), na_kalman(otter$Trout[61:80]), na_kalman(otter$Trout[81:100]))

##use imp_Altitude and imp_Trout instead of Altitude and Trout for the rest of analysis!!!
```

*Include explanation of data processing methods and reasoning*

```{r}
# correlation matrix for the numerical variables
corr.dat <- otter[c('imp_Altitude', 'imp_Trout', 'Caloric', 'Water.Excess', 'Amoeba', 'Water')]
chart.Correlation(corr.dat, histogram = TRUE)
```

```{r}
# correlation matrix for the numerical variables
corr.dat2 <- otter[c('Activity', 'imp_Altitude', 'imp_Trout', 'Caloric', 'Water.Excess', 'Amoeba', 'Water', 'Month')]
chart.Correlation(corr.dat2, histogram = TRUE)
```

```{r}
qqnorm(otter$Activity)
qqline(otter$Activity) #right-skewed, use log transformation
qqnorm(otter$imp_Altitude)
qqline(otter$imp_Altitude) #right-skewed, use log transformation
qqnorm(otter$imp_Trout)
qqline(otter$imp_Trout) #right-skewed, use log transformation
qqnorm(otter$Caloric)
qqline(otter$Caloric)
qqnorm(otter$Water.Excess)
qqline(otter$Water.Excess) #water excess follows a normal distribution
qqnorm(otter$Amoeba)
qqline(otter$Amoeba)
qqnorm(otter$Water)
qqline(otter$Water)
```



*Thomas can you add your code here for the plot that you made with each otter's activity over time?*

```{r}
ggplot(data =otter, aes(x = Month, y = Activity)) + geom_line(mapping = aes(colour = Otter)) + labs(title = "Activity Trends Over Time", caption = "Figure 1") + theme(plot.title = element_text(hjust = 0.5))

ggplot(data =otter, aes(x = Month, y = log(Activity))) + geom_line(mapping = aes(colour = Otter)) + labs(title = "Logarithm of Activity Trends Over Time", caption = "Figure 2") + theme(plot.title = element_text(hjust = 0.5))
```

Preliminary findings: RO-599 is the only otter that has an obviously non-stationary trend
 - examined mean, variance, covariance
 - we may consider detrending or differencing just this otter
 

```{r warning=FALSE, message=FALSE}
# plot of altitude affecting activity over time for each otter type
(alt.plot <- ggplot(otter, aes(x = imp_Altitude, y = Activity)) + geom_point(mapping = aes(colour = Otter)) + geom_smooth(aes(colour = Otter), method = lm, se = FALSE) +
  labs(title = 'Altitude and Activity by Otter Type', xlab = 'Altitude', ylab = 'Activity') +
  theme(plot.title = element_text(hjust = 0.5)))

# plot of altitude affecting activity over time for each otter type after transformations
(alt.plot <- ggplot(otter, aes(x = log(imp_Altitude), y = log(Activity))) + geom_point(mapping = aes(colour = Otter)) + geom_smooth(aes(colour = Otter), method = lm, se = FALSE) +
  labs(title = 'Altitude and Activity by Otter Type', xlab = 'logarithm of Altitude', ylab = 'logarithm of Activity') +
  theme(plot.title = element_text(hjust = 0.5)))

# plot of trout affecting activity over time for each otter type
(trout.plot <- ggplot(otter, aes(x = imp_Trout, y = Activity)) + geom_point(mapping = aes(colour = Otter)) + geom_smooth(aes(colour = Otter), method = lm, se = FALSE) +
  labs(title = 'Trout and Activity by Otter Type', xlab = 'Trout', ylab = 'Activity') +
  theme(plot.title = element_text(hjust = 0.5)))

# plot of trout affecting activity over time for each otter type after transformations
(trout.plot <- ggplot(otter, aes(x = log(imp_Trout), y = log(Activity))) + geom_point(mapping = aes(colour = Otter)) + geom_smooth(aes(colour = Otter), method = lm, se = FALSE) +
  labs(title = 'Trout and Activity by Otter Type', xlab = 'logarithm of Trout', ylab = 'logarithm of Activity') +
  theme(plot.title = element_text(hjust = 0.5)))

# plot of caloric affecting activity over time for each otter type
(caloric.plot <- ggplot(otter, aes(x = Caloric, y = Activity)) + geom_point(mapping = aes(colour = Otter)) + geom_smooth(aes(colour = Otter), method = lm, se = FALSE) +
  labs(title = 'Caloric and Activity by Otter Type', xlab = 'Caloric', ylab = 'Activity') +
  theme(plot.title = element_text(hjust = 0.5)))

# plot of water excess affecting activity over time for each otter type
(water.ex.plot <- ggplot(otter, aes(x = Water.Excess, y = Activity)) + geom_point(mapping = aes(colour = Otter)) + geom_smooth(aes(colour = Otter), method = lm, se = FALSE) +
  labs(title = 'Water Excess and Activity by Otter Type', xlab = 'Water Excess', ylab = 'Activity') +
  theme(plot.title = element_text(hjust = 0.5)))

# plot of amoeba affecting activity over time for each otter type
(amoeba.plot <- ggplot(otter, aes(x = Amoeba, y = Activity)) + geom_point(mapping = aes(colour = Otter)) + geom_smooth(aes(colour = Otter), method = lm, se = FALSE) +
  labs(title = 'Amoeba and Activity by Otter Type', xlab = 'Amoeba', ylab = 'Activity') +
  theme(plot.title = element_text(hjust = 0.5)))

# plot of water affecting activity over time for each otter type
(water.plot <- ggplot(otter, aes(x = Water, y = Activity)) + geom_point(mapping = aes(colour = Otter)) + geom_smooth(aes(colour = Otter), method = lm, se = FALSE) +
  labs(title = 'Water and Activity by Otter Type', xlab = 'Water', ylab = 'Activity') +
  theme(plot.title = element_text(hjust = 0.5)))
```

```{r}
# Possibly fix this line later to include all six plots together. For now, we can just use the chunk above.

#ggarrange(plotlist = alt.plot, trout.plot, caloric.plot, water.ex.plot, amoeba.plot, water.plot)
```

```{r}
otter$lActivity = log(otter$Activity)
otter$lAltitude = log(otter$imp_Altitude)
otter$lTrout = log(otter$imp_Trout)

otters.amoeba = subset(otter, !is.na(Amoeba))

otters.water = subset(otter, !is.na(Water))

(amoeba.plot <- ggplot(otters.amoeba, aes(x = Amoeba, y = Activity)) + geom_point(mapping = aes(colour = Otter)) + geom_smooth(aes(colour = Otter), method = lm, se = FALSE) +
  labs(title = 'Amoeba and Activity by Otter Type', xlab = 'Amoeba', ylab = 'Activity') +
  theme(plot.title = element_text(hjust = 0.5)))

# plot of water affecting activity over time for each otter type
(water.plot <- ggplot(otters.water, aes(x = Water, y = Activity)) + geom_point(mapping = aes(colour = Otter)) + geom_smooth(aes(colour = Otter), method = lm, se = FALSE) +
  labs(title = 'Water and Activity by Otter Type', xlab = 'Water', ylab = 'Activity') +
  theme(plot.title = element_text(hjust = 0.5)))
```

```{r}
library(tseries)
library(MTS)
library(vars)
```

```{r}
otter = subset(otter, select = -c(Altitude, Trout, Lat., Long.))
```

```{r}
ro.599 = subset(otter, Otter == "RO-599")
ro.599 = subset(ro.599, select = -c(Otter, Site, Month, Month.1, Year, Water))
ro.918 = subset(otter, Otter == "RO-918")
ro.918 = subset(ro.918, select = -c(Otter, Site, Month, Month.1, Year))
ro.859 = subset(otter, Otter == "RO-859")
ro.859 = subset(ro.859, select = -c(Otter, Site, Month, Month.1, Year, Water))
ro.106 = subset(otter, Otter == "RO-106")
ro.106 = subset(ro.106, select = -c(Otter, Site, Month, Month.1, Year, Amoeba))
ro.255 = subset(otter, Otter == "RO-255")
ro.255 = subset(ro.255, select = -c(Otter, Site, Month, Month.1, Year, Amoeba))

ro.599.ts = ts(ro.599,
               frequency = 12,
               start = c(2018, 7))

ro.918.ts = ts(ro.918,
               frequency = 12,
               start = c(2018, 7))

ro.859.ts = ts(ro.859,
               frequency = 12,
               start = c(2018, 7))

ro.106.ts = ts(ro.106,
               frequency = 12,
               start = c(2018, 7))

ro.255.ts = ts(ro.255,
               frequency = 12,
               start = c(2018, 7))
```

```{r}
apply(ro.918.ts, 2, adf.test)
```

```{r}
ro.918.ts.stnry = diffM(ro.918.ts)

apply(ro.918.ts.stnry, 2, adf.test)
```

```{r}
plot.ts(ro.918.ts.stnry)
```

```{r}
var.918 = VAR(ro.918.ts.stnry,
              ic = "AIC",
              type = "none")

summary(var.918)
```


```{r}
library(nlme)
#model selections
m1.amb.ml = lme(lActivity ~ lAltitude + lTrout + Caloric + Water.Excess + Amoeba + Month + Site + lAltitude:Otter + lTrout:Otter + Amoeba:Otter, random = ~1+Month|Otter, otters.amoeba, method = "ML")

AIC(m1.amb.ml)
AIC(update(m1.amb.ml, .~.-Amoeba:Otter))
AIC(update(m1.amb.ml, .~.-lTrout:Otter)) #choose this model for the 1st step
AIC(update(m1.amb.ml, .~.-lAltitude:Otter))

```

```{r}

# create a ML model without lTrout:Otter
m2.amb.ml = lme(lActivity ~ lAltitude + lTrout + Caloric + Water.Excess + Amoeba + Month + Site + lAltitude:Otter + Amoeba:Otter, random = ~1+Month|Otter, otters.amoeba, method = "ML")

AIC(m2.amb.ml)
AIC(update(m2.amb.ml, .~.-Amoeba:Otter))
AIC(update(m2.amb.ml, .~.-lAltitude:Otter)) #choose this model for the 2nd step 
```

```{r}

# create a ML model without lAltitude:Otter
m3.amb.ml = lme(lActivity ~ lAltitude + lTrout + Caloric + Water.Excess + Amoeba + Month + Site + Amoeba:Otter, random = ~1+Month|Otter, otters.amoeba, method = "ML")

AIC(m3.amb.ml)
AIC(update(m3.amb.ml, .~.-Amoeba:Otter)) #a high AIC, keep the Amoeba:Otter and its corresponding main effects

#In addition, check whether we should remove other main effects

AIC(update(m3.amb.ml, .~.-lAltitude))
AIC(update(m3.amb.ml, .~.-lTrout)) #choose this model for the 3rd step
AIC(update(m3.amb.ml, .~.-Caloric)) 
AIC(update(m3.amb.ml, .~.-Water.Excess))
AIC(update(m3.amb.ml, .~.-Month))
AIC(update(m3.amb.ml, .~.-Site))
```

```{r}
# create a ML model without lTrout
m4.amb.ml = lme(lActivity ~ lAltitude + Caloric + Water.Excess + Amoeba + Month + Site + Amoeba:Otter, random = ~1+Month|Otter, otters.amoeba, method = "ML")

AIC(m4.amb.ml)
AIC(update(m4.amb.ml, .~.-lAltitude))
AIC(update(m4.amb.ml, .~.-Caloric)) 
AIC(update(m4.amb.ml, .~.-Water.Excess)) #choose this model for the 4th step
#AIC(update(m4.amb.ml, .~.-Month))
AIC(update(m4.amb.ml, .~.-Amoeba:Otter))
AIC(update(m4.amb.ml, .~.-Amoeba))
#AIC(update(m4.amb.ml, .~.-Site)) 
```


```{r}
# create a ML model without Water.Excess
m5.amb.ml = lme(lActivity ~ lAltitude + Caloric + Amoeba + Month + Site + Amoeba:Otter, random = ~1+Month|Otter, otters.amoeba, method = "ML")

AIC(m5.amb.ml)
AIC(update(m5.amb.ml, .~.-lAltitude))
AIC(update(m5.amb.ml, .~.-Caloric))
#AIC(update(m5.amb.ml, .~.-Month))
AIC(update(m5.amb.ml, .~.-Amoeba:Otter))
AIC(update(m5.amb.ml, .~.-Amoeba)) #The lowest AIC is reached, which is the same as in m5.amb.ml
AIC(update(m5.amb.ml, .~.-Site)) 
```


```{r}
m5.amb.reml = lme(lActivity ~ lAltitude + Caloric + Amoeba + Month + Site + Amoeba:Otter, random = ~1+Month|Otter, otters.amoeba)
#create a model using REML methods with intercept only

m6.amb.reml = lme(lActivity ~ lAltitude + Caloric + Amoeba + Month + Site + Amoeba:Otter, random = ~1|Otter, otters.amoeba)
lrtest(m5.amb.reml, m6.amb.reml)
#p=0.988 

#compare with the linear regression model without random effect
m7.amb.reml = lm(lActivity ~ lAltitude + Caloric + Amoeba + Month + Site + Amoeba:Otter, otters.amoeba, method = "REML")
lrtest(m6.amb.reml, m7.amb.reml)
#p < 0.05, m6.amb.reml with intercept as the random effect will be our final model
summary(m6.amb.reml) 
```




```{r}
m1.wt.ml = lme(lActivity ~ lAltitude + lTrout + Caloric + Water.Excess + Water + Month + Site + lAltitude:Otter + lTrout:Otter, random = ~1+Month|Otter, method = "ML", otters.water)

AIC(m1.wt.ml)
#AIC(update(m1.wt.ml, .~.-lTrout:Otter)) 
AIC(update(m1.wt.ml, .~.-lAltitude:Otter)) #choose this model for the 1st step of model selection
```

```{r}
#remove lAltitude:Otter
m2.wt.ml = lme(lActivity ~ lAltitude + lTrout + Caloric + Water.Excess + Water + Month + Site + lTrout:Otter, random = ~1+Month|Otter, method = "ML", otters.water)

AIC(m2.wt.ml)
#AIC(update(m2.wt.ml, .~.-lTrout:Otter))
AIC(update(m2.wt.ml, .~.-lAltitude))
AIC(update(m2.wt.ml, .~.-lTrout))
AIC(update(m2.wt.ml, .~.-Caloric))
AIC(update(m2.wt.ml, .~.-Water.Excess)) #choose this model for the 2nd step of model selection
AIC(update(m2.wt.ml, .~.-Water))
#AIC(update(m2.wt.ml, .~.-Month))
#AIC(update(m2.wt.ml, .~.-Site)) 
```


```{r}
#remove Water.Excess
m3.wt.ml = lme(lActivity ~ lAltitude + lTrout + Caloric + Water + Month + Site + lTrout:Otter, random = ~1+Month|Otter, method = "ML", otters.water)

AIC(m3.wt.ml)
#AIC(update(m3.wt.ml, .~.-lTrout:Otter))
AIC(update(m3.wt.ml, .~.-lAltitude))
AIC(update(m3.wt.ml, .~.-lTrout))
AIC(update(m3.wt.ml, .~.-Caloric)) #choose this model for the 3rd step of model selection
AIC(update(m3.wt.ml, .~.-Water))
#AIC(update(m3.wt.ml, .~.-Month))
#AIC(update(m3.wt.ml, .~.-Site))
```




```{r}
#remove Water.Excess
m4.wt.ml = lme(lActivity ~ lAltitude + lTrout + Water + Month + Site + lTrout:Otter, random = ~1+Month|Otter, method = "ML", otters.water)

AIC(m4.wt.ml)
#AIC(update(m4.wt.ml, .~.-lTrout:Otter))
AIC(update(m4.wt.ml, .~.-lAltitude))
AIC(update(m4.wt.ml, .~.-lT4rout))
AIC(update(m4.wt.ml, .~.-Water)) #choose this model for the 4th step of model selection
#AIC(update(m4.wt.ml, .~.-Month))
#AIC(update(m4.wt.ml, .~.-Site))
```




```{r}
#remove Water.Excess
m5.wt.ml = lme(lActivity ~ lAltitude + lTrout + Month + Site + lTrout:Otter, random = ~1+Month|Otter, method = "ML", otters.water)

AIC(m5.wt.ml)
#AIC(update(m5.wt.ml, .~.-lTrout:Otter))
AIC(update(m5.wt.ml, .~.-lAltitude))
AIC(update(m5.wt.ml, .~.-lTrout)) #AIC is the same as in m5.wt.ml, model selection of fixed effect is done
#AIC(update(m5.wt.ml, .~.-Month))
#AIC(update(m5.wt.ml, .~.-Site))

summary(m5.wt.ml)
```

```{r}
m5.wt.reml = lme(lActivity ~ lAltitude + lTrout + Month + Site + lTrout:Otter, random = ~1+Month|Otter, method = "REML", otters.water)

m6.wt.reml = lme(lActivity ~ lAltitude + lTrout + Month + Site + lTrout:Otter, random = ~1|Otter, method = "REML", otters.water)

AIC(m5.wt.reml)
AIC(m6.wt.reml) #choose m6.wt.reml over m5.wt

m7.wt.reml = lm(lActivity ~ lAltitude + lTrout + Month + Site + lTrout:Otter, otters.water, method = "REML")
lrtest(m6.wt.reml, m7.wt.reml)
#p < 0.05, m6.wt.reml is the final model
```


```{r}
summary(m6.wt.reml)
```



```{r}

```



